@inherits LayoutComponentBase
@implements IDisposable

@inject MessageService MessageService
@inject CartState CartState
@inject UiState UiState
@inject ICartsService CartService
@inject AuthenticationStateProvider AuthProvider

<div class="app-layout">
    <aside class="app-sidebar">
        <NavMenu />
    </aside>

    <main class="app-main">
        <div style="min-height: 40px;" class="d-flex justify-content-end align-items-center px-4">
            <AuthorizeView>
                <Authorized>
                    @if (CartState.ItemsCount > 0)
                    {
                        <a href="/cart"
                           class="btn btn-outline-light btn-sm d-inline-flex align-items-center gap-2 rounded-pill px-3"
                           title="Košík">
                            <span class="d-none d-sm-inline">Košík</span>
                            <img src="icons/cart.svg" width="18" height="18" alt="cart_icon" />
                            <span class="badge bg-primary rounded-pill">@CartState.ItemsCount</span>
                        </a>
                    }
                </Authorized>
            </AuthorizeView>
        </div>
        <div class="px-4 pt-3">
            <div style="min-height: 64px;">
                @if (MessageService.Current is not null)
                {
                    var css = MessageService.Current.Type switch
                    {
                        MessageType.Success => "alert-success",
                        MessageType.Warning => "alert-warning",
                        MessageType.Error => "alert-danger",
                        _ => "alert-info"
                    };

                    <div class="alert @css d-flex justify-content-between align-items-center mb-0 py-2"
                         role="alert">
                        <span>@MessageService.Current.Text</span>
                        <button type="button" class="btn-close" @onclick="ClearMessage"></button>
                    </div>
                }
            </div>
        </div>

        <article class="content px-4">
            @Body
        </article>

        <footer class="mt-5 border-top border-secondary-subtle">
            <div class="px-4 py-3 d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2">
                <div class="small text-muted">
                    © @DateTime.Now.Year ElectronicsEshop
                    <span class="mx-2">•</span>
                    <span class="d-inline-flex align-items-center gap-2">
                        <span class="text-muted">Podpora:</span>
                        <a class="link-dark text-muted text-decoration-none" href="/contact">Kontaktujte nás</a>
                    </span>
                </div>
            </div>
        </footer>

    </main>
</div>

@if (UiState.IsBusy)
{
    <div class="busy-overlay">
        <div class="busy-card">
            <div class="spinner-border" role="status" aria-hidden="true"></div>
            <div class="mt-3">@UiState.BusyText</div>
        </div>
    </div>
}


@code {
    private bool _cartLoaded;

    protected override void OnInitialized()
    {
        MessageService.OnChange += StateHasChanged;
        CartState.OnChange += StateHasChanged;
        UiState.OnChange += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        await RefreshCartCountIfAuthenticated();
    }

    private async Task RefreshCartCountIfAuthenticated()
    {
        if (_cartLoaded)
            return;

        var auth = await AuthProvider.GetAuthenticationStateAsync();
        if(auth.User.Identity?.IsAuthenticated != true)
        {
            CartState.Clear();
            _cartLoaded = true;
            return;
        }

        try
        {
            await CartService.SyncCountAsync();
        }
        catch
        {
            CartState.Clear();
        }
        finally
        {
            _cartLoaded = true;
        }
    }

    public void Dispose()
    {
        MessageService.OnChange -= StateHasChanged;
        CartState.OnChange -= StateHasChanged;
        UiState.OnChange -= StateHasChanged;
    }

    private void ClearMessage() => MessageService.Clear();
}
