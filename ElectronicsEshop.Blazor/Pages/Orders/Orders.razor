@page "/orders"
@attribute [Authorize]

@inject IOrderService OrderService
@inject MessageService MessageService
@inject NavigationManager Nav

<PageTitle>Moje objednávky</PageTitle>

<h3 class="d-flex align-items-center gap-2 mb-3">
    Moje objednávky
    @if(isLoading)
    {
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        <span class="text-muted small">Načítám...</span>
    }
</h3>

@if(!isLoading && !model.Items.Any())
{
    <div class="alert alert-info">
        Zatím nemáte žádné objednávky.
    </div>
}
else if(!isLoading)
{
    <div class="d-flex justify-content-between align-items-center mb-3">

        <div class="d-flex flex-column justify-content-center me-3">
            <label class="form-label mb-1 small text-muted">Stav objednávky</label>
            <select class="form-select form-select-sm"
                    value="@(request.OrderStatus?.ToString() ?? "")"
                    @onchange="OnSelectedOrderStatusAsync">
                <option value="">Všechny</option>
                @foreach (var s in statuses)
                {
                    <option value="@s.Key">@s.Value</option>
                }
            </select>
        </div>

        <div class="text-muted small">
            Stránka @model.Page / @TotalPages,
            Celkem @model.TotalCount objednávek
        </div>

        <div class="d-flex align-items-center gap-2">
            <span class="small text-muted">Na stránku:</span>
            <select class="form-select form-select-sm w-auto" @onchange="OnPageSizeChanged" value="@request.PageSize">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
            </select>

            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" @onclick="PreviousPageAsync" disabled="@(!CanGoPrevious)">
                    Předchozí
                </button>
                <button class="btn btn-outline-secondary" @onclick="NextPageAsync" disabled="@(!CanGoNext)">
                    Další
                </button>
            </div>
        </div>
    </div>

    <div class="row g-3">
        @foreach (var order in model.Items)
        {
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">

                        <div class="mb-2 mb-md-0">
                            <div class="fw-semibold">
                                Objednávka #@order.Id
                            </div>
                            <div class="small text-muted">
                                Vytvořeno: @order.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                            </div>

                            <div class="mt-1">
                                <span class="badge rounded-pill @OrderStatusHelper.GetStatusBadgeClass(order.OrderStatus)">
                                    @OrderStatusHelper.GetCzechOrderStatusName(order.OrderStatus)
                                </span>

                                @if (order.CanceledAt is not null)
                                {
                                    <span class="badge bg-warning text-dark ms-1">
                                        Zrušeno: @order.CanceledAt.Value.ToString("dd.MM.yyyy HH:mm")
                                    </span>
                                }
                            </div>

                            <div class="small text-muted mt-1">
                                Položek: @order.ItemsCount
                            </div>
                        </div>

                        <div class="text-end ms-md-3">
                            <div class="fw-bold fs-5">
                                @order.TotalAmount.ToString("N2") Kč
                            </div>

                            <button class="btn btn-sm btn-primary mt-2"
                                    @onclick="() => GoToDetail(order.Id)">
                                Detail objednávky
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted small">
            Stránka @model.Page / @TotalPages
        </div>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" @onclick="PreviousPageAsync" disabled="@(!CanGoPrevious)">
                Předchozí
            </button>
            <button class="btn btn-outline-secondary" @onclick="NextPageAsync" disabled="@(!CanGoNext)">
                Další
            </button>
        </div>
    </div>
}


@code {
    private PagedResult<OrderListItemModel> model = new();
    private CommonPageRequest request = new()
    {
        Page = 1,
        PageSize = 10
    };

    private bool isLoading;
    private Dictionary<OrderStatus, string> statuses = new();

    private int TotalPages => model.PageSize == 0
        ? 0
        : (int)Math.Ceiling((double)model.TotalCount / model.PageSize);

    private bool CanGoPrevious => model.Page > 1;
    private bool CanGoNext => model.Page < TotalPages;

    protected override async Task OnInitializedAsync()
    {
        statuses = OrderStatusHelper.StatusLabels();
        await LoadOrdersAsync();
    }

    private async Task LoadOrdersAsync()
    {
        try
        {
            isLoading = true;
            model = await OrderService.GetAllAsync(request);
        }
        catch(Exception ex)
        {
            MessageService.ShowError(ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task PreviousPageAsync()
    {
        if (!CanGoPrevious)
            return;

        request.Page--;
        await LoadOrdersAsync();
    }

    private async Task NextPageAsync()
    {
        if (!CanGoNext)
            return;

        request.Page++;
        await LoadOrdersAsync();
    }

    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        if(int.TryParse(e.Value?.ToString(), out var pageSize))
        {
            request.PageSize = pageSize;
        }
        else
        {
            request.PageSize = 10;
        }

        request.Page = 1;
        await LoadOrdersAsync();
    }

    private async Task OnSelectedOrderStatusAsync(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();

        if(string.IsNullOrWhiteSpace(value))
        {
            request.OrderStatus = null;
        }
        else if(Enum.TryParse<OrderStatus>(value, out var status))
        {
            request.OrderStatus = status;
        }
        else
        {
            return;
        }

        request.Page = 1;
        await LoadOrdersAsync();
    }

    private void GoToDetail(int orderId)
    {
        Nav.NavigateTo($"/orders/{orderId}");
    }
}
