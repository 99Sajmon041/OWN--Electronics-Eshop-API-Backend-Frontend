@page "/admin/payments"

@using System.Globalization
@using ElectronicsEshop.Blazor.Models.Common
@using ElectronicsEshop.Blazor.Models.Payments

@attribute [Authorize(Roles = nameof(UserRoles.Admin))]

@inject IPaymentsService PaymentsService
@inject MessageService MessageService
@inject NavigationManager Nav

<h3 class="mb-3">Přehled plateb</h3>

<div class="card mb-3">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-12 col-md-3">
                <label class="form-label">ID uživatele</label>
                <input class="form-control"
                       value="@request.UserId"
                       @oninput="OnUserIdChanged"
                       @onkeydown="OnFilteredKeyDownUserId"
                       placeholder="ID uživatele..." />
            </div>

            <div class="col-12 col-md-2">
                <label class="form-label">ID objednávky</label>
                <input class="form-control"
                       type="number"
                       value="@(request.OrderId?.ToString() ?? string.Empty)"
                       @oninput="OnOrderIdChanged"
                       @onkeydown="OnFilteredKeyDownOrderId"
                       placeholder="např. 123" />
            </div>

            <div class="col-12 col-md-2">
                <label class="form-label">Od</label>
                <input class="form-control"
                       type="date"
                       value="@(request.From?.ToString("yyyy-MM-dd"))"
                       @onchange="OnFilteredDateFrom" />
            </div>

            <div class="col-12 col-md-2">
                <label class="form-label">Do</label>
                <input class="form-control"
                       type="date"
                       value="@(request.To?.ToString("yyyy-MM-dd"))"
                       @onchange="OnFilteredDateTo" />
            </div>

            <div class="col-12 col-md-1">
                <label class="form-label">Velikost stránky</label>
                <select class="form-select" value="@request.PageSize" @onchange="OnPageSizeChanged">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="alert alert-info">Načítám platby…</div>
}
else if (payments is null || payments.Items is null || payments.Items.Count == 0)
{
    <div class="alert alert-secondary">
        Žádné platby k zobrazení (zkus upravit filtry).
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead>
                <tr>
                    <th style="white-space:nowrap;">ID platby</th>
                    <th style="white-space:nowrap;">ID uživatele</th>
                    <th style="white-space:nowrap;">ID objednávky</th>
                    <th style="white-space:nowrap;">Částka</th>
                    <th style="white-space:nowrap;">Status</th>
                    <th style="white-space:nowrap;">Vytvořeno</th>
                    <th style="white-space:nowrap;">Upraveno</th>
                    <th style="white-space:nowrap;">Chybová hláška</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in payments.Items)
                {
                    <tr>
                        <td>@p.Id</td>
                        <td style="max-width:280px; overflow:hidden; text-overflow:ellipsis;">@p.UserId</td>
                        <td>@(p.OrderId?.ToString() ?? "-")</td>
                        <td>@FormatMoney(p.Amount)</td>
                        <td>@EnumsHelper.GetCzechPaymentStatusName(p.Status)</td>
                        <td>@FormatDateTime(p.CreatedAt)</td>
                        <td>@(p.UpdatedAt.HasValue? FormatDateTime(p.UpdatedAt.Value) : "-")</td>
                        <td style="max-width:380px; overflow:hidden; text-overflow:ellipsis;">
                            @(!string.IsNullOrWhiteSpace(p.ErrorMessage) ? p.ErrorMessage : "-")
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<div class="d-flex align-items-center justify-content-between mt-3">
    <div class="text-muted">
        Celkem: <strong>@(payments?.TotalCount ?? 0)</strong>,
        Strana: <strong>@request.Page</strong>/<strong>@totalPages</strong>
    </div>

    <div class="btn-group">
        <button class="btn btn-outline-light" @onclick="GoFirst" disabled="@(!canGoPrevious || isLoading)">⏮</button>
        <button class="btn btn-outline-light" @onclick="GoPrevious" disabled="@(!canGoPrevious || isLoading)">Předchozí</button>
        <button class="btn btn-outline-light" @onclick="GoNext" disabled="@(!canGoNext || isLoading)">Další</button>
        <button class="btn btn-outline-light" @onclick="GoLast" disabled="@(!canGoNext || isLoading)">⏭</button>
    </div>
</div>

@code {
    private PaymentRequest request = new();
    private PagedResult<PaymentModel> payments = new() { Items = [], TotalCount = 0, Page = 1, PageSize = 20 };
    private bool isLoading;

    private int totalPages => Math.Max(1, (int)Math.Ceiling((double)(payments?.TotalCount ?? 0) / Math.Max(1, request.PageSize)));
    private bool canGoPrevious => request.Page > 1;
    private bool canGoNext => request.Page < totalPages;

    protected override async Task OnInitializedAsync()
    {
        var today = DateTime.Today;
        request.From = today.AddYears(-1);
        request.To = today;

        request.Page = 1;
        await LoadPaymentsAsync();
    }

    private async Task LoadPaymentsAsync()
    {
        isLoading = true;

        try
        {
            payments = await PaymentsService.GetAllAsync(request);

            if (payments is null)
                payments = new PagedResult<PaymentModel>
                {
                    Items = [],
                    TotalCount = 0,
                    Page = request.Page,
                    PageSize = request.PageSize
                };
        }
        catch (Exception ex)
        {
            MessageService.ShowError(ex.Message);
            payments = new PagedResult<PaymentModel>
            {
                Items = [],
                TotalCount = 0,
                Page = request.Page,
                PageSize = request.PageSize
            };
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GoFirst()
    {
        if (!canGoPrevious) return;
        request.Page = 1;
        await LoadPaymentsAsync();
    }

    private async Task GoPrevious()
    {
        if (!canGoPrevious) return;
        request.Page--;
        await LoadPaymentsAsync();
    }

    private async Task GoNext()
    {
        if (!canGoNext) return;
        request.Page++;
        await LoadPaymentsAsync();
    }

    private async Task GoLast()
    {
        if (!canGoNext) return;
        request.Page = totalPages;
        await LoadPaymentsAsync();
    }

    private static string FormatDateTime(DateTime dt)
        => dt.ToString("dd.MM.yyyy HH:mm", CultureInfo.GetCultureInfo("cs-CZ"));

    private static string FormatMoney(decimal amount)
        => amount.ToString("N2", CultureInfo.GetCultureInfo("cs-CZ"));

    private async Task OnUserIdChanged(ChangeEventArgs e)
    {
        request.UserId = e.Value?.ToString();

        if (string.IsNullOrWhiteSpace(request.UserId))
            request.UserId = null;

        request.Page = 1;
        await LoadPaymentsAsync();
    }

    private async Task OnFilteredKeyDownUserId(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            request.UserId = null;
            request.Page = 1;
            await LoadPaymentsAsync();
        }
    }

    private async Task OnOrderIdChanged(ChangeEventArgs e)
    {
        var raw = e.Value?.ToString();

        if (string.IsNullOrWhiteSpace(raw))
        {
            request.OrderId = null;
            request.Page = 1;
            await LoadPaymentsAsync();
            return;
        }

        if (!int.TryParse(raw, out var orderId))
            return;

        request.OrderId = orderId;
        request.Page = 1;
        await LoadPaymentsAsync();
    }

    private async Task OnFilteredKeyDownOrderId(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            request.OrderId = null;
            request.Page = 1;
            await LoadPaymentsAsync();
        }
    }

    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var pageSize))
            request.PageSize = pageSize;
        else
            request.PageSize = 10;

        request.Page = 1;
        await LoadPaymentsAsync();
    }

    private async Task OnFilteredDateFrom(ChangeEventArgs e)
    {
        var raw = e.Value?.ToString();

        if (string.IsNullOrWhiteSpace(raw))
        {
            request.From = null;
            request.Page = 1;
            await LoadPaymentsAsync();
            return;
        }

        if (!DateTime.TryParseExact(raw, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var newFrom))
        {
            MessageService.ShowError("Neplatné datum 'Od'.");
            return;
        }

        if (request.To.HasValue && newFrom.Date > request.To.Value.Date)
        {
            MessageService.ShowError("Datum 'Od' nesmí být větší než datum 'Do'.");
            return;
        }

        request.From = newFrom.Date;
        request.Page = 1;
        await LoadPaymentsAsync();
    }

    private async Task OnFilteredDateTo(ChangeEventArgs e)
    {
        var raw = e.Value?.ToString();

        if (string.IsNullOrWhiteSpace(raw))
        {
            request.To = null;
            request.Page = 1;
            await LoadPaymentsAsync();
            return;
        }

        if (!DateTime.TryParseExact(raw, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var newTo))
        {
            MessageService.ShowError("Neplatné datum 'Do'.");
            return;
        }

        if (request.From.HasValue && newTo.Date < request.From.Value.Date)
        {
            MessageService.ShowError("Datum 'Do' nesmí být menší než datum 'Od'.");
            return;
        }

        request.To = newTo.Date;
        request.Page = 1;
        await LoadPaymentsAsync();
    }
}
