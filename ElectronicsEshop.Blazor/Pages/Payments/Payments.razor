@page "/admin/payments"

@using System.Globalization
@using ElectronicsEshop.Blazor.Models.Common
@using ElectronicsEshop.Blazor.Models.Payments

@attribute [Authorize(Roles = nameof(UserRoles.Admin))]

@inject IPaymentsService PaymentsService
@inject MessageService MessageService
@inject NavigationManager Nav

<h3 class="mb-3">Přehled plateb</h3>

<div class="card mb-3">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-12 col-md-3">
                <label class="form-label">UserId</label>
                <input class="form-control" @bind="request.UserId" @bind:event="oninput" placeholder="např. Identity UserId" />
            </div>

            <div class="col-12 col-md-2">
                <label class="form-label">OrderId</label>
                <input class="form-control" type="number" @bind="orderIdInput" placeholder="např. 123" />
            </div>

            <div class="col-12 col-md-2">
                <label class="form-label">Od</label>
                <input class="form-control" type="date" @bind="fromInput" />
            </div>

            <div class="col-12 col-md-2">
                <label class="form-label">Do</label>
                <input class="form-control" type="date" @bind="toInput" />
            </div>

            <div class="col-12 col-md-1">
                <label class="form-label">PageSize</label>
                <select class="form-select" @bind="request.PageSize">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>

            <div class="col-12 col-md-2 d-flex gap-2">
                <button class="btn btn-primary w-100" @onclick="ApplyFiltersAsync" disabled="@isLoading">
                    Hledat
                </button>
                <button class="btn btn-outline-secondary w-100" @onclick="ResetFiltersAsync" disabled="@isLoading">
                    Reset
                </button>
            </div>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="alert alert-info">Načítám platby…</div>
}
else if (payments is null || payments.Items is null || payments.Items.Count == 0)
{
    <div class="alert alert-secondary">
        Žádné platby k zobrazení (zkus upravit filtry).
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-dark table-striped table-hover align-middle">
            <thead>
                <tr>
                    <th style="white-space:nowrap;">ID</th>
                    <th style="white-space:nowrap;">UserId</th>
                    <th style="white-space:nowrap;">OrderId</th>
                    <th style="white-space:nowrap;">Amount</th>
                    <th style="white-space:nowrap;">Status</th>
                    <th style="white-space:nowrap;">Created</th>
                    <th style="white-space:nowrap;">Updated</th>
                    <th style="white-space:nowrap;">Error</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in payments.Items)
                {
                    <tr>
                        <td>@p.Id</td>
                        <td style="max-width:280px; overflow:hidden; text-overflow:ellipsis;">@p.UserId</td>
                        <td>@(p.OrderId?.ToString() ?? "-")</td>
                        <td>@FormatMoney(p.Amount)</td>
                        <td>@p.Status</td>
                        <td>@FormatDateTime(p.CreatedAt)</td>
                        <td>@(p.UpdatedAt.HasValue? FormatDateTime(p.UpdatedAt.Value) : "-")</td>
                        <td style="max-width:380px; overflow:hidden; text-overflow:ellipsis;">
                            @(!string.IsNullOrWhiteSpace(p.ErrorMessage) ? p.ErrorMessage : "-")
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<div class="d-flex align-items-center justify-content-between mt-3">
    <div class="text-muted">
        Celkem: <strong>@payments?.TotalCount</strong>,
        Strana: <strong>@request.Page</strong>/<strong>@totalPages</strong>
    </div>

    <div class="btn-group">
        <button class="btn btn-outline-light" @onclick="GoFirst" disabled="@(!canGoPrevious || isLoading)">⏮</button>
        <button class="btn btn-outline-light" @onclick="GoPrevious" disabled="@(!canGoPrevious || isLoading)">Předchozí</button>
        <button class="btn btn-outline-light" @onclick="GoNext" disabled="@(!canGoNext || isLoading)">Další</button>
        <button class="btn btn-outline-light" @onclick="GoLast" disabled="@(!canGoNext || isLoading)">⏭</button>
    </div>
</div>

@code {
    private PaymentRequest request = new();
    private PagedResult<PaymentModel> payments = new() { Items = [], TotalCount = 0, Page = 1, PageSize = 20 };

    private bool isLoading;

    private int? orderIdInput;
    private DateTime? fromInput;
    private DateTime? toInput;

    private int totalPages => Math.Max(1, (int)Math.Ceiling((double)(payments?.TotalCount ?? 0) / Math.Max(1, request.PageSize)));
    private bool canGoPrevious => request.Page > 1;
    private bool canGoNext => request.Page < totalPages;

    protected override async Task OnInitializedAsync()
    {
        orderIdInput = request.OrderId;
        fromInput = request.From;
        toInput = request.To;

        await LoadPaymentsAsync();
    }

    private async Task ApplyFiltersAsync()
    {
        if (fromInput.HasValue && toInput.HasValue && toInput.Value.Date < fromInput.Value.Date)
        {
            MessageService.ShowError("Datum 'Do' musí být větší nebo rovno datu 'Od'.");
            return;
        }

        request.OrderId = orderIdInput;
        request.From = fromInput?.Date;
        request.To = toInput?.Date;

        request.Page = 1; 
        await LoadPaymentsAsync();
    }

    private async Task ResetFiltersAsync()
    {
        request = new PaymentRequest
        {
            Page = 1,
            PageSize = request.PageSize
        };

        orderIdInput = null;
        fromInput = null;
        toInput = null;

        await LoadPaymentsAsync();
    }

    private async Task LoadPaymentsAsync()
    {
        isLoading = true;

        try
        {
            payments = await PaymentsService.GetAllAsync(request);

            if (payments is null)
                payments = new PagedResult<PaymentModel> { Items = [], TotalCount = 0, Page = request.Page, PageSize = request.PageSize };
        }
        catch (Exception ex)
        {
            MessageService.ShowError(ex.Message);
            payments = new PagedResult<PaymentModel> { Items = [], TotalCount = 0, Page = request.Page, PageSize = request.PageSize };
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GoFirst()
    {
        if (!canGoPrevious) return;
        request.Page = 1;
        await LoadPaymentsAsync();
    }

    private async Task GoPrevious()
    {
        if (!canGoPrevious) return;
        request.Page--;
        await LoadPaymentsAsync();
    }

    private async Task GoNext()
    {
        if (!canGoNext) return;
        request.Page++;
        await LoadPaymentsAsync();
    }

    private async Task GoLast()
    {
        if (!canGoNext) return;
        request.Page = totalPages;
        await LoadPaymentsAsync();
    }

    private static string FormatDateTime(DateTime dt)
    {
        return dt.ToString("dd.MM.yyyy HH:mm", CultureInfo.GetCultureInfo("cs-CZ"));
    }

    private static string FormatMoney(decimal amount)
    {
        return amount.ToString("N2", CultureInfo.GetCultureInfo("cs-CZ"));
    }
}
