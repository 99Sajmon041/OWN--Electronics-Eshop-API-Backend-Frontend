@page "/admin/products/create"
@attribute [Authorize(Roles = nameof(UserRoles.Admin))]

@inject IProductAdminService productAdminService
@inject NavigationManager Nav
@inject MessageService MessageService
@inject ICategoryService CategoryService

<PageTitle>Vytvoření produktu</PageTitle>

@if(!canRender)
{
    <p>Načítám...</p>
    return;
}

<h3>Vytvoření produktu</h3>

<EditForm Model="model" OnValidSubmit="PostProductsAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="card">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Kód produktu</label>
                    <InputText class="form-control" @bind-Value="model.ProductCode" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">Název</label>
                    <InputText class="form-control" @bind-Value="model.Name" />
                </div>

                <div class="col-md-4 d-flex align-items-end">
                    <div class="form-check">
                        <InputCheckbox class="form-check-input" @bind-Value="model.IsActive" />
                        <label class="form-check-label">Aktivní</label>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Kategorie</label>
                    <InputSelect class="form-select" @bind-Value="model.CategoryId">
                        @foreach (var kvp in categories)
                        {
                            <option value="@kvp.Key">@kvp.Value</option>
                        }
                    </InputSelect>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Cena</label>
                    <div class="input-group">
                        <InputNumber @bind-Value="model.Price" class="form-control" step="0.01" />
                        <span class="input-group-text">Kč</span>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Sleva (%)</label>
                    <div class="input-group">
                        <InputNumber @bind-Value="model.DiscountPercentage" class="form-control" step="0.01" />
                        <span class="input-group-text">%</span>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Kusů skladem</label>
                    <InputNumber class="form-control" @bind-Value="model.StockQty" />
                </div>

                <div class="col-md-9">
                    <label class="form-label">Popis</label>
                    <InputTextArea class="form-control" @bind-Value="model.Description" rows="4" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">Obrázek produktu</label>
                    <InputFile OnChange="OnImageSelected" class="form-control" />
                    <div class="form-text">
                        Vyberte obrázek produktu (např. JPG/PNG).
                    </div>
                </div>
            </div>
        </div>

        <div class="card-footer d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" @onclick="BackToList">
                Zpět na seznam
            </button>
            <button type="submit" class="btn btn-primary">
                Vytvořit produkt
            </button>
        </div>
    </div>
</EditForm>

@code {
    private CreateProductModel model = new();
    private IDictionary<int, string> categories = new Dictionary<int, string>();
    private bool canRender = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            categories = await CategoryService.GetAllCategiresAsync();

            if (categories is null || categories.Count == 0)
            {
                MessageService.ShowError("Nejsou k dispozici žádné kategorie, prvně musíte nějaké vytvořit.");
                Nav.NavigateTo("/admin/categories/create");
                return;
            }
            model.CategoryId = categories.First().Key;
            canRender = true;
        }
        catch (Exception ex)
        {
            MessageService.ShowError(ex.Message);
            BackToList();
        }
    }

    private async Task PostProductsAsync()
    {
        try
        {
            await productAdminService.CreateAsync(model);
            MessageService.ShowSuccess("Produkt byl vytvořen.");
            Nav.NavigateTo("/admin/products");
        }
        catch (Exception ex)
        {
            MessageService.ShowError(ex.Message);
        }
    }

    private void BackToList()
    {
        Nav.NavigateTo("/admin/products");
    }

    private void OnImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        if(file is null)
        {
            model.ImageFile = null;
            return;
        }

        model.ImageFile = file;
    }
}
