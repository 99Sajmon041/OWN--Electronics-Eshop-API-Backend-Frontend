@page "/"

@inject IProductService ProductService
@inject ICategoryService CategoryService
@inject MessageService MessageService
@inject ICartsService CartsService
@inject NavigationManager Nav
@inject HttpClient Http

<PageTitle>Seznam produktů</PageTitle>


<div class="text-center my-4">
    <h3 class="mb-1">Katalog produktů</h3>

    <div style="min-height: 24px;">
        @if (isLoading)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span class="text-muted small ms-2">Načítám...</span>
        }
    </div>
</div>

<div class="container">
    <ul class="nav nav-pills mb-3">
        <li class="nav-item">
            <button class="@GetCategoryTabClass(null)"
                    @onclick="() => OnCategorySelectedAsync(null)">
                Vše
            </button>
        </li>

        @foreach (var kvp in categories)
        {
            <li class="nav-item">
                <button class="@GetCategoryTabClass(kvp.Key)"
                        @onclick="() => OnCategorySelectedAsync(kvp.Key)">
                    @kvp.Value
                </button>
            </li>
        }
    </ul>

    <div class="row mb-3">
        <div class="col-md-6">
            <input class="form-control"
                   placeholder="Hledat produkt..."
                   value="@filter.Q"
                   @oninput="OnSearchCahnged"
                   @onkeydown="OnCanceledFiltering" />
        </div>
    </div>

    @if (!isLoading && (products is null || !products.Items.Any()))
    {
        <div class="alert alert-info">
            Pro zvolený filtr nebyly nalezeny žádné produkty.
        </div>
    }
    else if (!isLoading)
    {
        <div class="row g-3">
            @foreach (var product in products!.Items)
            {
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="card h-100">
                        @if (!string.IsNullOrWhiteSpace(product.ImageUrl))
                        {
                            <div class="card-img-top d-flex align-items-center justify-content-center"
                                 style="height: 180px; background-color: #f8f9fa;">
                                <img src="@Http.GetImageUrl(product.ImageUrl)"
                                     alt="@product.Name"
                                     style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                            </div>
                        }
                        else
                        {
                            <div class="card-img-top d-flex align-items-center justify-content-center"
                                 style="height: 180px; background-color: #f8f9fa;">
                                <span class="text-muted">Bez obrázku</span>
                            </div>
                        }

                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@product.Name</h5>

                            <p class="text-muted mb-1">@product.CategoryName</p>

                            @if (!string.IsNullOrWhiteSpace(product.Description))
                            {
                                <p class="card-text text-muted text-truncate">
                                    @product.Description
                                </p>
                            }

                            @if (product.DiscountPercentage > 0)
                            {
                                <p class="mb-1">
                                    <span class="text-decoration-line-through text-muted me-2">
                                        @product.Price.ToString("C")
                                    </span>
                                    <span class="fw-bold">
                                        @product.FinalPrice.ToString("C")
                                    </span>
                                    <span class="badge bg-danger ms-1">
                                        -@product.DiscountPercentage %
                                    </span>
                                </p>
                            }
                            else
                            {
                                <p class="fw-bold mb-1">
                                    @product.Price.ToString("C")
                                </p>
                            }

                            <p class="text-muted mb-2">
                                Skladem: @product.StockQty ks
                            </p>

                            <div class="mt-auto d-flex align-items-center justify-content-between gap-2">

                                <button class="btn btn-primary btn-sm" @onclick="@(() => GoToDetail(product.Id))">
                                    Detail
                                </button>

                                <AuthorizeView>
                                    <Authorized>
                                        <div class="d-flex align-items-center gap-2">

                                            <div class="input-group input-group-sm" style="width: 130px;">
                                                <button class="btn btn-outline-secondary"
                                                        type="button"
                                                        disabled="@(isLoading || GetQty(product.Id) <= 1)"
                                                        @onclick="() => DecreaseQty(product.Id)">
                                                    −
                                                </button>

                                                <input class="form-control text-center"
                                                       value="@GetQty(product.Id)"
                                                       readonly />

                                                <button class="btn btn-outline-secondary"
                                                        type="button"
                                                        disabled="@(isLoading || GetQty(product.Id) >= product.StockQty)"
                                                        @onclick="() => IncreaseQty(product.Id, product.StockQty)">
                                                    +
                                                </button>
                                            </div>

                                            <button class="btn btn-warning btn-sm"
                                                    disabled="@(isLoading || product.StockQty <= 0)"
                                                    @onclick="@(() => AddToCartAsync(product.Id, product.Name))">
                                                Přidat
                                            </button>
                                        </div>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <nav class="mt-4">
            <ul class="pagination justify-content-center">

                <li class="page-item @(filter.Page <= 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="PrevPageAsync">Předchozí</button>
                </li>

                @for (int i = 1; i <= GetTotalPages(); i++)
                {
                    <li class="page-item @(i == filter.Page ? "active" : "")">
                        <button class="page-link" @onclick="(() => GoToPageAsync(i))">@i</button>
                    </li>
                }

                <li class="page-item @(filter.Page >= GetTotalPages() ? "disabled" : "")">
                    <button class="page-link" @onclick="NextPageAsync">Další</button>
                </li>
            </ul>

            <p class="text-center text-muted">
                Strana @filter.Page z @GetTotalPages()
                &nbsp;|&nbsp;
                Celkem @products.TotalCount produktů
            </p>
        </nav>
    }
</div>

@code {
    private Models.Products.Self.GetProducts.ProductRequest filter = new();

    private IDictionary<int, string> categories = new Dictionary<int, string>();
    private readonly Dictionary<int, int> qtyByProductId = new();
    private PagedResult<ProductModel>? products;
    private bool isLoading;

    protected override async Task OnInitializedAsync()
    {
        categories = await CategoryService.GetAllCategiresAsync();
        await LoadProductsAsync();
    }

    private async Task LoadProductsAsync()
    {
        isLoading = true;
        StateHasChanged();

        products = await ProductService.GetAllAsync(filter);

        isLoading = false;
        StateHasChanged();
    }

    private string GetCategoryTabClass(int? categoryId)
    {
        var isActive = filter.CategoryId == categoryId;
        return $"nav-link {(isActive ? "active" : "")}";
    }

    private async Task OnCategorySelectedAsync(int? categoryId)
    {
        filter.CategoryId = categoryId;
        filter.Page = 1;
        await LoadProductsAsync();
    }

    private async Task OnSearchCahnged(ChangeEventArgs e)
    {
        filter.Q = e.Value?.ToString() ?? string.Empty;
        await SearchAsync();
    }

    private void OnCanceledFiltering(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            filter.Q = string.Empty;
            _ = SearchAsync();
        }
    }

    private async Task SearchAsync()
    {
        filter.Page = 1;
        await LoadProductsAsync();
    }

    private int GetTotalPages()
    {
        if (products is null || products.PageSize <= 0)
            return 1;

        return (int)Math.Ceiling((double)products.TotalCount / products.PageSize);
    }

    private async Task PrevPageAsync()
    {
        if (filter.Page > 1)
        {
            filter.Page--;
            await LoadProductsAsync();
        }
    }

    private async Task NextPageAsync()
    {
        var totalPages = GetTotalPages();

        if (filter.Page < totalPages)
        {
            filter.Page++;
            await LoadProductsAsync();
        }
    }

    private async Task GoToPageAsync(int page)
    {
        var totalPages = GetTotalPages();

        if (page >= 1 && page <= totalPages)
        {
            filter.Page = page;
            await LoadProductsAsync();
        }
    }

    private void GoToDetail(int productId)
    {
        Nav.NavigateTo($"/products/detail/{productId}");
    }

    private async Task AddToCartAsync(int productId, string productName)
    {
        var quantity = GetQty(productId);

        var model = new AddToCartModel
        {
            ProductId = productId,
            Quantity = quantity
        };

        try
        {
            await CartsService.AddItemAsync(model, productName);

            qtyByProductId.Clear();

            await LoadProductsAsync();
            MessageService.ShowSuccess($"Zboží {productName} bylo x{quantity} přidáno do košíku.");
        }
        catch (Exception ex)
        {
            MessageService.ShowError(ex.Message);
        }
    }

    private int GetQty(int productId)
    {
        if(!qtyByProductId.TryGetValue(productId, out var qty))
        {
            qty = 1;
            qtyByProductId[productId] = qty;
        }

        return qty;
    }

    private void DecreaseQty(int productId)
    {
        var qty = GetQty(productId);
        if (qty > 1)
        {
            qtyByProductId[productId] = qty - 1;
        }
    }

    private void IncreaseQty(int productId, int max)
    {
        var qty = GetQty(productId);
        if(qty < max)
        {
            qtyByProductId[productId] = qty + 1;
        }
    }
}
