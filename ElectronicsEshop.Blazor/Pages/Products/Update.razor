@page "/admin/products/update/{Id:int}"
@using ElectronicsEshop.Blazor.Models.Products.Shared

@attribute [Authorize(Roles = nameof(UserRoles.Admin))]

@inject IProductAdminService productAdminService
@inject NavigationManager Nav
@inject MessageService MessageService
@inject ICategoryService CategoryService
@inject HttpClient Http

<PageTitle>Úprava produktu</PageTitle>

@if (!canRender)
{
    <p>Načítám...</p>
    return;
}

<h3>Úprava produktu @model.Name</h3>

<EditForm Model="model" OnValidSubmit="PutProductAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="card">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Kód produktu</label>
                    <InputText class="form-control" @bind-Value="model.ProductCode" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">Název</label>
                    <InputText class="form-control" @bind-Value="model.Name" />
                </div>

                <div class="col-md-4 d-flex align-items-end">
                    <div class="form-check">
                        <InputCheckbox class="form-check-input" @bind-Value="model.IsActive" />
                        <label class="form-check-label">Aktivní</label>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Kategorie</label>
                    <InputSelect class="form-select" @bind-Value="model.CategoryId">
                        @foreach (var kvp in categories)
                        {
                            <option value="@kvp.Key">@kvp.Value</option>
                        }
                    </InputSelect>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Cena</label>
                    <div class="input-group">
                        <InputNumber @bind-Value="model.Price" class="form-control" step="0.01" />
                        <span class="input-group-text">Kč</span>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Sleva (%)</label>
                    <div class="input-group">
                        <InputNumber @bind-Value="model.DiscountPercentage" class="form-control" step="0.01" />
                        <span class="input-group-text">%</span>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Kusů skladem</label>
                    <InputNumber class="form-control" @bind-Value="model.StockQty" />
                </div>

                <div class="col-md-9">
                    <label class="form-label">Popis</label>
                    <InputTextArea class="form-control" @bind-Value="model.Description" rows="4" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">Obrázek produktu</label>

                    <div class="mb-2">
                        <img src="@Http.GetImageUrl(product.ImageUrl)"
                             alt="Produkt"
                             class="img-thumbnail"
                             style="max-width: 220px; height: auto;" />
                    </div>

                    <div class="form-text">
                        Tento obrázek nelze upravit na této stránce.
                        Pro změnu použijte akci „Obrázek“ v seznamu produktů.
                    </div>
                </div>
            </div>
        </div>

        <div class="card-footer d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" @onclick="BackToList">
                Zpět na seznam
            </button>
            <button type="submit" class="btn btn-primary">
                Upravit produkt
            </button>
        </div>
    </div>
</EditForm>


@code {
    [Parameter]
    public int Id { get; set; }

    private UpdateProductModel model = new();
    private ProductModel product = new();
    private IDictionary<int, string> categories = new Dictionary<int, string>();
    private bool canRender = false;
    private string categoryName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            categories = await CategoryService.GetAllCategiresAsync();

            if(categories is null || categories.Count == 0)
            {
                MessageService.ShowError("Nejsou k dispozici žádné kategorie, prvně musíte nějaké vytvořit.");
                Nav.NavigateTo("/admin/categories/create");
                return;
            }

            await SetProductAsync();
            canRender = true;
        }
        catch(Exception ex)
        {
            MessageService.ShowError(ex.Message);
            BackToList();
        }
    }

    private async Task SetProductAsync()
    {
        try
        {
            product = await productAdminService.GetByIdAsync(Id);
            model = product.ToUpdatemodel();
            categoryName = product.CategoryName;
            model.CategoryId = categories.First(c => c.Value == categoryName).Key;
        }
        catch(Exception ex)
        {
            MessageService.ShowError(ex.Message);
            BackToList();
        }
    }

    private async Task PutProductAsync()
    {
        try
        {
            await productAdminService.UpdateAsync(Id, model);
            MessageService.ShowSuccess($"Produkt s ID: {Id} byl upraven.");
            BackToList();
        }
        catch (Exception ex)
        {
            MessageService.ShowError(ex.Message);
        }
    }

    private void BackToList()
    {
        Nav.NavigateTo("/admin/products");
    }
}
